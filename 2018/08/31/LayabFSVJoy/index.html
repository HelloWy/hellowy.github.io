<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="LayaBox," />










<meta name="description" content="近期学习了Layabox游戏引擎，对游戏开发有了一定的认知，希望通过这次整理、总结 近期所学，能更近一步。使用Layabox引擎制作虚拟摇杆是很方便，我通过官方示例给出的代码制作 (参考LayaAir 3D角色脚本控制与碰撞检测)并详细解释一下 重要的代码段。   创建虚拟摇杆UI界面使用LayaAirIDE创建摇杆UI布局 创建一个Page ——&amp;gt; view 设置合适的宽高（例如：30">
<meta name="keywords" content="LayaBox">
<meta property="og:type" content="article">
<meta property="og:title" content="LayaBox虚拟摇杆详细描述Layabox FSVJoy">
<meta property="og:url" content="http://yoursite.com/2018/08/31/LayabFSVJoy/index.html">
<meta property="og:site_name" content="Kelvin&#39;s blog">
<meta property="og:description" content="近期学习了Layabox游戏引擎，对游戏开发有了一定的认知，希望通过这次整理、总结 近期所学，能更近一步。使用Layabox引擎制作虚拟摇杆是很方便，我通过官方示例给出的代码制作 (参考LayaAir 3D角色脚本控制与碰撞检测)并详细解释一下 重要的代码段。   创建虚拟摇杆UI界面使用LayaAirIDE创建摇杆UI布局 创建一个Page ——&amp;gt; view 设置合适的宽高（例如：30">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/08/31/LayabFSVJoy/createFSVJoyLayout.jpg">
<meta property="og:image" content="http://yoursite.com/2018/08/31/LayabFSVJoy/FSVJoyXY.jpg">
<meta property="og:image" content="http://yoursite.com/2018/08/31/LayabFSVJoy/FSVjoyComputeAngal.jpg">
<meta property="og:updated_time" content="2018-08-31T03:55:39.143Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LayaBox虚拟摇杆详细描述Layabox FSVJoy">
<meta name="twitter:description" content="近期学习了Layabox游戏引擎，对游戏开发有了一定的认知，希望通过这次整理、总结 近期所学，能更近一步。使用Layabox引擎制作虚拟摇杆是很方便，我通过官方示例给出的代码制作 (参考LayaAir 3D角色脚本控制与碰撞检测)并详细解释一下 重要的代码段。   创建虚拟摇杆UI界面使用LayaAirIDE创建摇杆UI布局 创建一个Page ——&amp;gt; view 设置合适的宽高（例如：30">
<meta name="twitter:image" content="http://yoursite.com/2018/08/31/LayabFSVJoy/createFSVJoyLayout.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/31/LayabFSVJoy/"/>





  <title>LayaBox虚拟摇杆详细描述Layabox FSVJoy | Kelvin's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kelvin's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Life was like a box of chocolate ,you never know what you're gonna get.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/31/LayabFSVJoy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kelvin Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kelvin's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LayaBox虚拟摇杆详细描述Layabox FSVJoy</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-31T11:55:39+08:00">
                2018-08-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/游戏开发/" itemprop="url" rel="index">
                    <span itemprop="name">游戏开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote>
<p>近期学习了Layabox游戏引擎，对游戏开发有了一定的认知，希望通过这次整理、总结 近期所学，能更近一步。<br>使用Layabox引擎制作虚拟摇杆是很方便，我通过官方示例给出的代码制作 (参考<a href="https://ldc.layabox.com/doc/?nav=zh-ts-4-1-1" target="_blank" rel="noopener">LayaAir 3D角色脚本控制与碰撞检测</a>)<br>并详细解释一下 重要的代码段。</p>
</blockquote>
<hr>
<h2 id="创建虚拟摇杆UI界面"><a href="#创建虚拟摇杆UI界面" class="headerlink" title="创建虚拟摇杆UI界面"></a>创建虚拟摇杆UI界面</h2><h3 id="使用LayaAirIDE创建摇杆UI布局"><a href="#使用LayaAirIDE创建摇杆UI布局" class="headerlink" title="使用LayaAirIDE创建摇杆UI布局"></a>使用LayaAirIDE创建摇杆UI布局</h3><ul>
<li><p>创建一个Page ——&gt; view 设置合适的宽高（例如：300 * 300）</p>
</li>
<li><p>在创建好的page内<br>拖入一个Sprite组件，设置透明度为0.5，并拖入一个circle组件到该Sprite组件下，设置x,y为150、150，半径为130。<br>然后拖入第二个Sprite组件(摇杆 定义变量名为knob)，同样设置x、y为150、150，再拖入一个circle到该Sprite下 设置半径为60、60。</p>
</li>
<li><p>如下图所示</p>
<img src="/2018/08/31/LayabFSVJoy/createFSVJoyLayout.jpg" title="创建UI模块">
</li>
<li><p>最后导出UI组件</p>
</li>
</ul>
<h2 id="必备知识"><a href="#必备知识" class="headerlink" title="必备知识"></a>必备知识</h2><h3 id="角度与弧度"><a href="#角度与弧度" class="headerlink" title="角度与弧度"></a>角度与弧度</h3><p>“弧度” 和 “角度” 是度量角的大小的两种不同的单位。</p>
<ol>
<li><p><strong>弧度制</strong><br>定义：弧长等于半径的弧，其所对的圆心角为1弧度。众所周知，圆的周长为 2πr，所以一周的弧度为 2π度。rad</p>
</li>
<li><p><strong>角度制</strong><br>定义：角度是用以量度角的单位，符号为“°”。一周角分为360等份，每份定义为1度（1°）。</p>
</li>
<li><p><strong>角度与弧度换算</strong><br>1° = (π/180) rad ≈ 0.017453 rad<br><br>1 rad = (180/π)° ≈ 57.295779°</p>
</li>
</ol>
<h3 id="在坐标系中理解tan、atan和atan2"><a href="#在坐标系中理解tan、atan和atan2" class="headerlink" title="在坐标系中理解tan、atan和atan2"></a>在坐标系中理解tan、atan和atan2</h3><blockquote>
<p>tanθ放在坐标系中 它的的值等价于dy/dx。坐标系内除了y轴，任何一个点(x,y)，相对于x轴的斜率就是y-0/x-0，也即是y/x。<br>tanθ就称为一条直线相对于x轴的斜率，那么θ就是相对于x轴的夹角（旋转角度）了。tan，是根据角度计算斜率的。那么反过来 arctan（反正切）自然就认为是根据斜率来计算角度的。</p>
<blockquote>
<p><strong>为何存在atan2 ?</strong><br>在JavaScript中，提供了两个arctan函数，一个是atan, 一个是atan2。 atan就是我们所熟知arctan。其实在很多编程语言中都提供了atan2。<br><strong>那么atan2又是怎么回事呢？</strong><br>要知道这个，需要知道arctan的不足之处：<br>arctan的返回值范围是(-π/2,  π/2) 不包括， ±π/2，也就是(两个点组成的直线与x轴夹角是90°)90°是计算不出来的。为啥呢?<br>在计算arctan ( dy/dx)时，如果两个点(x1,y1),(x2,y2)组成的直线与x轴的夹角呈90°时，dx= x2-x1 = 0 ，0 是不能作为除数的，所以就无法计算这种情形。<br>值的范围也就是计算的角度的范围在（-π/2,  π/2），从坐标系来看，这个角度的范围只能是在第1、4象限，并不能表示出第2、3象限的角。<br>为了弥补atan的不足，在计算机编程领域，引入了atan2函数，它的计算结果是在(-π,π]。它正好可以覆盖整个坐标系，包括90°的情形。</p>
</blockquote>
</blockquote>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><ol>
<li><p>导出UI模板后，在项目的src/ui下可以看到我们导出的LayaUI.max.all.ts文件，我们新建类继承我们的UI模块，对之前创建好的布局编写具体的操作逻辑。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> RockerView <span class="keyword">extends</span> ui.RockerUI&#123;</span><br><span class="line">    <span class="comment">/** 定义变量 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span> (<span class="params">touchSp:Laya.Sprite</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        </span><br><span class="line">        doSomething...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将虚拟摇杆控制器 originPiont 设置在中心位置</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器中心点位置初始化</span></span><br><span class="line"><span class="keyword">this</span>.originPiont = <span class="keyword">new</span> Laya.Point(<span class="keyword">this</span>.width/<span class="number">2</span>, <span class="keyword">this</span>.height/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="comment">// 更新控制点与摇杆中心点位置距离</span></span><br><span class="line"><span class="keyword">this</span>.deltaX = locationPos.x - <span class="keyword">this</span>.originPiont.x;</span><br><span class="line"><span class="keyword">this</span>.deltaY = locationPos.y - <span class="keyword">this</span>.originPiont.y;</span><br></pre></td></tr></table></figure>
<p>当我们计算角度弧度时 deltaX、deltaY所在的坐标轴即为下图</p>
<img src="/2018/08/31/LayabFSVJoy/FSVJoyXY.jpg" title="坐标轴图示">
</li>
<li><p>当手指按下，移动摇杆时，计算角度、弧度，监听 mousemove 事件 <strong>重点</strong></p>
<img src="/2018/08/31/LayabFSVJoy/FSVjoyComputeAngal.jpg" title="移动摇杆">
<p>如上图所示，当摇杆knob移动到坐标(x1,y1)时，对应角度θ，我们要计算出θ的度数和弧度。<br><strong>根据定义：tanθ = y1 / x1，又已知x1和y1的值，如何求出θ的度数？</strong><br>使用atan2函数，<strong>Math.atan2(y1,x1)</strong> (不要问我为什么传y1,x1，<strong>请参考<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/atan2" target="_blank" rel="noopener">MDN Math.atan2()</a></strong><br>Math.atan2(y1,x1)得出的是该角度的弧度值，我们可以通过 <strong>(1 rad = (180/π)° ≈ 57.295779°)</strong> 得出角度值。<br>代码示例如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将移动时的鼠标屏幕坐标转化为摇杆布局坐标</span></span><br><span class="line"><span class="keyword">var</span> locationPos:Laya.Point = <span class="keyword">this</span>.globalToLocal(<span class="keyword">new</span> Laya.Point(Laya.stage.mouseX, Laya.stage.mouseY), <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 更新摇杆控制点的位置</span></span><br><span class="line"><span class="keyword">this</span>.knob.pos(locationPos.x, locationPos.y);</span><br><span class="line"><span class="comment">// 更新控制点与摇杆中心点位置距离</span></span><br><span class="line"><span class="keyword">this</span>.deltaX = locationPos.x - <span class="keyword">this</span>.originPiont.x;</span><br><span class="line"><span class="keyword">this</span>.deltaY = locationPos.y - <span class="keyword">this</span>.originPiont.y;</span><br><span class="line"><span class="comment">// 计算控制点在摇杆中的角度</span></span><br><span class="line"><span class="keyword">var</span> dx:<span class="built_in">number</span> = <span class="keyword">this</span>.deltaX * <span class="keyword">this</span>.deltaX;</span><br><span class="line"><span class="keyword">var</span> dy:<span class="built_in">number</span> = <span class="keyword">this</span>.deltaY * <span class="keyword">this</span>.deltaY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.angle = <span class="built_in">Math</span>.atan2(<span class="keyword">this</span>.deltaY, <span class="keyword">this</span>.deltaX) * <span class="number">180</span> / <span class="built_in">Math</span>.PI;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.angle &lt; <span class="number">0</span>) <span class="keyword">this</span>.angle += <span class="number">360</span>;</span><br><span class="line"><span class="comment">// 对角度取整</span></span><br><span class="line"><span class="keyword">this</span>.angle = <span class="built_in">Math</span>.round(<span class="keyword">this</span>.angle);</span><br><span class="line"><span class="comment">// 计算控制点在摇杆中的弧度</span></span><br><span class="line"><span class="keyword">this</span>.radians = <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="keyword">this</span>.angle;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制控制点与中心点距离不超过130</span></span><br><span class="line"><span class="comment">// 勾股定理 a² + b² = c²</span></span><br><span class="line"><span class="keyword">if</span> (dx+dy &gt;= <span class="number">130</span>*<span class="number">130</span>)&#123;</span><br><span class="line">    <span class="comment">// 控制点在半径为130像素的位置（根据弧度变化）</span></span><br><span class="line">    <span class="keyword">var</span> x:<span class="built_in">number</span> = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.cos(<span class="keyword">this</span>.radians) * <span class="number">130</span> + <span class="keyword">this</span>.originPiont.x);</span><br><span class="line">    <span class="keyword">var</span> y:<span class="built_in">number</span> = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.sin(<span class="keyword">this</span>.radians) * <span class="number">130</span> + <span class="keyword">this</span>.originPiont.y);</span><br><span class="line">    <span class="keyword">this</span>.knob.pos(x,y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 不超过130像素取原坐标</span></span><br><span class="line">    <span class="keyword">this</span>.knob.pos(locationPos.x, locationPos.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当希望通过θ rad得出x1,y1时<br>x1 = Math.cos(θ rad) × 控制点半径<br>y1 = Math.sin(θ rad) × 控制点半径</p>
</li>
</ol>
<h2 id="具体代码实现"><a href="#具体代码实现" class="headerlink" title="具体代码实现"></a>具体代码实现</h2><ol>
<li><p>RockerView.ts 控制器虚拟摇杆类</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> RockerView <span class="keyword">extends</span> ui.RockerUI&#123;</span><br><span class="line">    <span class="comment">/** 触摸区域 */</span></span><br><span class="line">    <span class="keyword">private</span> touchRect:Laya.Sprite;</span><br><span class="line">    <span class="comment">/** 控制器中心点 */</span></span><br><span class="line">    <span class="keyword">private</span> originPiont:Laya.Point;</span><br><span class="line">    <span class="comment">/** 摇杆与中心点的X轴距离 */</span></span><br><span class="line">    <span class="keyword">private</span> deltaX:<span class="built_in">number</span>;</span><br><span class="line">    <span class="comment">/** 摇杆与中心点的Y轴距离 */</span></span><br><span class="line">    <span class="keyword">private</span> deltaY:<span class="built_in">number</span>;</span><br><span class="line">    <span class="comment">/** 当前多点触摸Id */</span></span><br><span class="line">    <span class="keyword">private</span> curTouchId:<span class="built_in">number</span>=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/** 手指（鼠标）是否按下 */</span></span><br><span class="line">    <span class="keyword">private</span> isDown:<span class="built_in">Boolean</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/** 摇杆角度 */</span></span><br><span class="line">    <span class="keyword">public</span> angle:<span class="built_in">number</span>=<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/** 摇杆弧度 */</span></span><br><span class="line">    <span class="keyword">public</span> radians:<span class="built_in">number</span>=<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/** 是否左手遥控 */</span></span><br><span class="line">    <span class="keyword">public</span> isleftControl:<span class="built_in">Boolean</span>=<span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span> (<span class="params">touchSp:Laya.Sprite</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.touchRect = touchSp;</span><br><span class="line">        <span class="comment">//鼠标按下事件监听</span></span><br><span class="line">        <span class="keyword">this</span>.touchRect.on(Laya.Event.MOUSE_DOWN,<span class="keyword">this</span>,<span class="keyword">this</span>.onMouseDown);</span><br><span class="line">        <span class="comment">//鼠标抬起事件监听</span></span><br><span class="line">        <span class="keyword">this</span>.touchRect.on(Laya.Event.MOUSE_UP,<span class="keyword">this</span>,<span class="keyword">this</span>.onMouseUp);</span><br><span class="line">        <span class="comment">// 控制器中心点位置初始化</span></span><br><span class="line">        <span class="keyword">this</span>.originPiont = <span class="keyword">new</span> Laya.Point(<span class="keyword">this</span>.width/<span class="number">2</span>, <span class="keyword">this</span>.height/<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 默认为控制器不显示</span></span><br><span class="line">        <span class="keyword">this</span>.visible = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 鼠标按下事件 */</span></span><br><span class="line">    <span class="keyword">private</span> onMouseDown(e:Laya.Event):<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="comment">// 左右手遥控</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.isleftControl)&#123;</span><br><span class="line">            <span class="comment">// 如果按下时是右边屏幕位置或已经按下鼠标，则返回</span></span><br><span class="line">            <span class="keyword">if</span>(e.stageX &gt; Laya.stage.width/<span class="number">2</span> || <span class="keyword">this</span>.isDown)<span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 如果按下时是左边屏幕位置或已经按下鼠标，则返回</span></span><br><span class="line">            <span class="keyword">if</span>(e.stageX &lt; Laya.stage.width/<span class="number">2</span> || <span class="keyword">this</span>.isDown)<span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录当前按下id</span></span><br><span class="line">        <span class="keyword">this</span>.curTouchId = e.touchId;</span><br><span class="line">        <span class="comment">// 已按下</span></span><br><span class="line">        <span class="keyword">this</span>.isDown = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 更新摇杆到屏幕按下位置</span></span><br><span class="line">        <span class="keyword">this</span>.pos(Laya.stage.mouseX - (<span class="keyword">this</span>.width / <span class="number">2</span>),Laya.stage.mouseY - (<span class="keyword">this</span>.height / <span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 初始化摇杆控制点位置</span></span><br><span class="line">        <span class="keyword">this</span>.knob.pos(<span class="keyword">this</span>.width / <span class="number">2</span>, <span class="keyword">this</span>.height/<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 按下后显示摇杆</span></span><br><span class="line">        <span class="keyword">this</span>.visible = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 摇杆移动监听事件</span></span><br><span class="line">        <span class="keyword">this</span>.touchRect.on(Laya.Event.MOUSE_MOVE, <span class="keyword">this</span>, <span class="keyword">this</span>.onMove);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*鼠标抬起事件回调*/</span></span><br><span class="line">    <span class="keyword">private</span> onMouseUp(e:Laya.Event):<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="comment">//如果不是上次的点击id，返回（避免多点抬起，以第一次按下id为准）</span></span><br><span class="line">        <span class="keyword">if</span>(e.touchId != <span class="keyword">this</span>.curTouchId)<span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.isDown = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.visible = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//移除摇杆移动事件监听</span></span><br><span class="line">        <span class="keyword">this</span>.touchRect.off(Laya.Event.MOUSE_MOVE,<span class="keyword">this</span>,<span class="keyword">this</span>.onMove);</span><br><span class="line">        <span class="comment">//修改摇杆角度与弧度为-1（代表无角度）</span></span><br><span class="line">        <span class="keyword">this</span>.radians = <span class="keyword">this</span>.angle = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 鼠标移动事件回调 */</span></span><br><span class="line">    <span class="keyword">private</span> onMove(e:Laya.Event):<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="comment">// 如果不是上次的点击id,返回（避免多点抬起，以第一次按下id为准）</span></span><br><span class="line">        <span class="keyword">if</span>(e.touchId != <span class="keyword">this</span>.curTouchId)<span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 将移动时的鼠标屏幕坐标转化为摇杆布局坐标</span></span><br><span class="line">        <span class="keyword">var</span> locationPos:Laya.Point = <span class="keyword">this</span>.globalToLocal(<span class="keyword">new</span> Laya.Point(Laya.stage.mouseX, Laya.stage.mouseY), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 更新摇杆控制点的位置</span></span><br><span class="line">        <span class="keyword">this</span>.knob.pos(locationPos.x, locationPos.y);</span><br><span class="line">        <span class="comment">// 更新控制点与摇杆中心点位置距离</span></span><br><span class="line">        <span class="keyword">this</span>.deltaX = locationPos.x - <span class="keyword">this</span>.originPiont.x;</span><br><span class="line">        <span class="keyword">this</span>.deltaY = locationPos.y - <span class="keyword">this</span>.originPiont.y;</span><br><span class="line">        <span class="comment">// 计算控制点在摇杆中的角度</span></span><br><span class="line">        <span class="keyword">var</span> dx:<span class="built_in">number</span> = <span class="keyword">this</span>.deltaX * <span class="keyword">this</span>.deltaX;</span><br><span class="line">        <span class="keyword">var</span> dy:<span class="built_in">number</span> = <span class="keyword">this</span>.deltaY * <span class="keyword">this</span>.deltaY;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.angle = <span class="built_in">Math</span>.atan2(<span class="keyword">this</span>.deltaY, <span class="keyword">this</span>.deltaX) * <span class="number">180</span> / <span class="built_in">Math</span>.PI;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.angle &lt; <span class="number">0</span>) <span class="keyword">this</span>.angle += <span class="number">360</span>;</span><br><span class="line">        <span class="comment">// 对角度取整</span></span><br><span class="line">        <span class="keyword">this</span>.angle = <span class="built_in">Math</span>.round(<span class="keyword">this</span>.angle);</span><br><span class="line">        <span class="comment">// 计算控制点在摇杆中的弧度</span></span><br><span class="line">        <span class="keyword">this</span>.radians = <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="keyword">this</span>.angle;</span><br><span class="line">        <span class="comment">// 强制控制点与中心点距离不超过130</span></span><br><span class="line">        <span class="comment">// 勾股定理 a² + b² = c²</span></span><br><span class="line">        <span class="keyword">if</span> (dx+dy &gt;= <span class="number">130</span>*<span class="number">130</span>)&#123;</span><br><span class="line">            <span class="comment">// 控制点在半径为130像素的位置（根据弧度变化）</span></span><br><span class="line">            <span class="keyword">var</span> x:<span class="built_in">number</span> = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.cos(<span class="keyword">this</span>.radians) * <span class="number">130</span> + <span class="keyword">this</span>.originPiont.x);</span><br><span class="line">            <span class="keyword">var</span> y:<span class="built_in">number</span> = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.sin(<span class="keyword">this</span>.radians) * <span class="number">130</span> + <span class="keyword">this</span>.originPiont.y);</span><br><span class="line">            <span class="keyword">this</span>.knob.pos(x,y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 不超过130像素取原坐标</span></span><br><span class="line">            <span class="keyword">this</span>.knob.pos(locationPos.x, locationPos.y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>引用RockerView时</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> GameMain &#123;</span><br><span class="line">    <span class="comment">/** 摇杆控制器 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> rocker: RockerView;</span><br><span class="line">    <span class="comment">/** 人物 */</span></span><br><span class="line">    <span class="keyword">private</span> hero:Role;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        Laya.WebGL.enable();</span><br><span class="line">        <span class="comment">// 不支持WebGL时自动切换至Canvas</span></span><br><span class="line">        Laya.init(<span class="number">1136</span>, <span class="number">700</span>, Laya.WebGL);</span><br><span class="line">        <span class="comment">// 实例化摇杆控制器</span></span><br><span class="line">        GameMain.rocker = <span class="keyword">new</span> RockerView(Laya.stage);</span><br><span class="line">        <span class="comment">// 实例化游戏人物</span></span><br><span class="line">        <span class="keyword">this</span>.hero = <span class="keyword">new</span> Role();</span><br><span class="line">        </span><br><span class="line">        Laya.timer.frameLoop(<span class="number">1</span>, <span class="keyword">this</span>, <span class="keyword">this</span>.loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    loop(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="comment">//通过弧度和速度计算角色在x，y轴上移动的量</span></span><br><span class="line">        <span class="keyword">var</span> incrementalX: <span class="built_in">number</span> = <span class="built_in">Math</span>.cos(DragonBonesDemo.rocker.radians) * <span class="keyword">this</span>.hero.speed;</span><br><span class="line">        <span class="keyword">var</span> incrementalY: <span class="built_in">number</span> = <span class="built_in">Math</span>.sin(DragonBonesDemo.rocker.radians) * <span class="keyword">this</span>.hero.speed;</span><br><span class="line">        <span class="comment">// 设置人物位置</span></span><br><span class="line">        <span class="keyword">this</span>.hero.pos(incrementalX, incrementalY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在这次虚拟摇杆开发学习，以及对官网代码的研究中，了解了反三角函数的运用，在后续 遇到旋转 二维坐标转换度数弧度时会有很大的帮助。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a href="https://blog.csdn.net/liyan530/article/details/77994019" target="_blank" rel="noopener">JavaScript- 使用 atan2 来绘制 箭头 和 曲线</a></li>
<li><a href="https://ldc.layabox.com/doc/?nav=zh-ts-4-1-1" target="_blank" rel="noopener">LayaAir 3D角色脚本控制与碰撞检测</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/atan2" target="_blank" rel="noopener">MDN Math.atan2()</a></li>
</ol>
<p><strong>按照引用顺序不分先后</strong></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LayaBox/" rel="tag"># LayaBox</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="Kelvin Wang" />
            
              <p class="site-author-name" itemprop="name">Kelvin Wang</p>
              <p class="site-description motion-element" itemprop="description">What's the difference between a man without a dream and a salted fish.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建虚拟摇杆UI界面"><span class="nav-number">1.</span> <span class="nav-text">创建虚拟摇杆UI界面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用LayaAirIDE创建摇杆UI布局"><span class="nav-number">1.1.</span> <span class="nav-text">使用LayaAirIDE创建摇杆UI布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#必备知识"><span class="nav-number">2.</span> <span class="nav-text">必备知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#角度与弧度"><span class="nav-number">2.1.</span> <span class="nav-text">角度与弧度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在坐标系中理解tan、atan和atan2"><span class="nav-number">2.2.</span> <span class="nav-text">在坐标系中理解tan、atan和atan2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码"><span class="nav-number">3.</span> <span class="nav-text">核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体代码实现"><span class="nav-number">4.</span> <span class="nav-text">具体代码实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kelvin Wang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
